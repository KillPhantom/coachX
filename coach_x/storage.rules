rules_version = '2';

// Firebase Storage Security Rules for CoachX
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to validate image file
    function isValidImage() {
      return request.resource.size < 10 * 1024 * 1024 // Max 10MB
             && request.resource.contentType.matches('image/.*');
    }

    // Helper function to validate video file
    function isValidVideo() {
      return request.resource.contentType.matches('video/.*');
    }

    // Helper function to validate voice file
    function isValidVoice() {
      return request.resource.size < 10 * 1024 * 1024 // Max 10MB
             && request.resource.contentType.matches('audio/.*');
    }

    // ==================== 训练计划图片 ====================
    // Path: training_plan_images/{userId}/{fileName}
    match /training_plan_images/{userId}/{fileName} {
      // 允许用户上传自己的训练计划图片
      allow write: if isOwner(userId) && isValidImage();
      // 允许用户读取自己的训练计划图片
      allow read: if isOwner(userId);
    }

    // ==================== 补剂计划图片 ====================
    // Path: supplement_plan_images/{userId}/{fileName}
    match /supplement_plan_images/{userId}/{fileName} {
      // 允许用户上传自己的补剂计划图片
      allow write: if isOwner(userId) && isValidImage();
      // 允许用户读取自己的补剂计划图片
      allow read: if isOwner(userId);
    }

    // ==================== 饮食计划图片 ====================
    // Path: diet_plan_images/{userId}/{fileName}
    match /diet_plan_images/{userId}/{fileName} {
      // 允许用户上传自己的饮食计划图片
      allow write: if isOwner(userId) && isValidImage();
      // 允许用户读取自己的饮食计划图片
      allow read: if isOwner(userId);
    }

    // ==================== AI食物扫描图片 ====================
    // Path: food_images/{userId}/{fileName}
    match /food_images/{userId}/{fileName} {
      // 允许用户上传自己的食物图片
      allow write: if isOwner(userId) && isValidImage();
      // 允许用户读取自己的食物图片
      allow read: if isOwner(userId);
    }

    // ==================== 饮食记录图片 ====================
    // Path: diet_images/{userId}/{fileName}
    match /diet_images/{userId}/{fileName} {
      // 允许用户上传自己的饮食记录图片
      allow write: if isOwner(userId) && isValidImage();
      // 允许用户读取自己的饮食记录图片
      allow read: if isOwner(userId);
    }

    // ==================== 身体数据图片 ====================
    // Path: body_stats/{userId}/{fileName}
    match /body_stats/{userId}/{fileName} {
      allow write: if isOwner(userId) && isValidImage();
      allow read: if isOwner(userId);
    }

    // ==================== 聊天图片 ====================
    // Path: chat_images/{conversationId}/{fileName}
    match /chat_images/{conversationId}/{fileName} {
      // 允许认证用户上传聊天图片
      allow write: if isAuthenticated() && isValidImage();
      // 允许认证用户读取聊天图片
      allow read: if isAuthenticated();
    }

    // ==================== 聊天媒体文件 ====================
    // Path: chat_media/{conversationId}/{mediaType}/{fileName}
    // mediaType: image | video | voice
    match /chat_media/{conversationId}/{mediaType}/{fileName} {
      // 允许认证用户上传聊天媒体（根据类型验证）
      allow write: if isAuthenticated() && (
        (mediaType == 'image' && isValidImage()) ||
        (mediaType == 'video' && isValidVideo()) ||
        (mediaType == 'voice' && isValidVoice())
      );
      // 允许认证用户读取聊天媒体
      allow read: if isAuthenticated();
    }

    // ==================== 用户头像 ====================
    // Path: avatars/{userId}/{fileName}
    match /avatars/{userId}/{fileName} {
      allow write: if isOwner(userId) && isValidImage();
      allow read: if isAuthenticated();
    }

    // ==================== 训练关键帧图片 ====================
    // Path: training_keyframes/{trainingId}/{fileName}
    match /training_keyframes/{trainingId}/{fileName} {
      // 允许所有认证用户读取关键帧（教练和学生）
      allow read: if isAuthenticated();
      // 允许认证用户上传关键帧图片（教练本地提取后上传）
      allow write: if isAuthenticated() && isValidImage();
    }

    // ==================== 训练反馈图片 ====================
    // Path: feedback_images/{dailyTrainingId}/{fileName}
    match /feedback_images/{dailyTrainingId}/{fileName} {
      // 允许已认证用户上传反馈图片（教练和学生都可以）
      allow write: if isAuthenticated() && isValidImage();
      // 允许已认证用户读取反馈图片
      allow read: if isAuthenticated();
    }

    // ==================== 训练反馈语音 ====================
    // Path: feedback_voices/{dailyTrainingId}/{fileName}
    match /feedback_voices/{dailyTrainingId}/{fileName} {
      // 允许已认证用户上传反馈语音（教练和学生都可以）
      allow write: if isAuthenticated();
      // 允许已认证用户读取反馈语音
      allow read: if isAuthenticated();
    }

    // ==================== 学生训练视频和缩略图 ====================
    // Path: students/trainings/{userId}/{fileName}
    match /students/trainings/{userId}/{fileName} {
      // 允许学生本人上传训练视频和缩略图
      allow write: if isOwner(userId) && (isValidVideo() || isValidImage());
      // 允许任何已认证用户读取（学生和教练都可以查看）
      allow read: if isAuthenticated();
    }

    // ==================== 教练动作库视频 ====================
    // Path: exercise_videos/{userId}/{fileName}
    match /exercise_videos/{userId}/{fileName} {
      // 允许教练本人上传动作库视频
      allow write: if isOwner(userId) && isValidVideo();
      // 允许任何已认证用户读取（教练和学生都可以查看）
      allow read: if isAuthenticated();
    }

    // ==================== 教练动作库视频缩略图 ====================
    // Path: exercise_thumbnails/{userId}/{fileName}
    match /exercise_thumbnails/{userId}/{fileName} {
      // 允许教练本人上传动作库视频缩略图
      allow write: if isOwner(userId) && isValidImage();
      // 允许任何已认证用户读取
      allow read: if isAuthenticated();
    }

    // ==================== 教练动作库图片 ====================
    // Path: exercise_images/{userId}/{fileName}
    match /exercise_images/{userId}/{fileName} {
      // 允许教练本人上传动作库辅助图片
      allow write: if isOwner(userId) && isValidImage();
      // 允许任何已认证用户读取
      allow read: if isAuthenticated();
    }

    // ==================== 教练动作库统一媒体 (新) ====================
    // Path: exercise_library/{userId}/{fileName}
    match /exercise_library/{userId}/{fileName} {
      // 允许教练本人上传视频或图片
      allow write: if isOwner(userId) && (isValidVideo() || isValidImage());
      // 允许任何已认证用户读取
      allow read: if isAuthenticated();
    }

    // 默认：拒绝所有其他访问
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
