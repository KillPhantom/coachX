rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== Helper Functions ====================

    // 检查用户是否已登录
    function isSignedIn() {
      return request.auth != null;
    }

    // 检查是否为文档拥有者
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ==================== Users Collection ====================

    match /users/{userId} {
      // 允许所有已登录用户读取用户文档（教练和学生需要互相查看基本信息）
      allow read: if isSignedIn();

      // 允许用户创建和更新自己的文档
      allow create, update: if isSignedIn() && request.auth.uid == userId;

      // 不允许删除用户文档
      allow delete: if false;
    }

    // ==================== Conversations Collection ====================

    match /conversations/{conversationId} {
      // 允许对话参与者读取
      allow read: if isSignedIn() &&
        (resource.data.coachId == request.auth.uid ||
         resource.data.studentId == request.auth.uid);

      // 允许对话参与者创建和更新
      allow create, update: if isSignedIn() &&
        (request.resource.data.coachId == request.auth.uid ||
         request.resource.data.studentId == request.auth.uid);

      // 不允许删除对话
      allow delete: if false;
    }

    // ==================== Messages Collection ====================

    match /messages/{messageId} {
      // 允许对话参与者读取消息（通过conversationId验证）
      allow read: if isSignedIn() && (
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.coachId == request.auth.uid ||
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.studentId == request.auth.uid
      );

      // 允许对话参与者创建消息
      allow create: if isSignedIn() && (
        get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.coachId == request.auth.uid ||
        get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.studentId == request.auth.uid
      );

      // 允许对话参与者更新消息状态（如标记已读）
      allow update: if isSignedIn() && (
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.coachId == request.auth.uid ||
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.studentId == request.auth.uid
      );

      // 不允许删除消息（使用软删除）
      allow delete: if false;
    }

    // ==================== Exercise Plans Collection ====================

    match /exercisePlans/{planId} {
      // 允许计划拥有者读取
      allow read: if isSignedIn() && resource.data.ownerId == request.auth.uid;

      // 允许计划拥有者创建、更新、删除
      allow create, update, delete: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
    }

    // ==================== Diet Plans Collection ====================

    match /dietPlans/{planId} {
      allow read: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow create, update, delete: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
    }

    // ==================== Supplement Plans Collection ====================

    match /supplementPlans/{planId} {
      allow read: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow create, update, delete: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
    }

    // ==================== Invitation Codes Collection ====================

    match /invitationCodes/{codeId} {
      // 允许所有已登录用户读取（用于验证邀请码）
      allow read: if isSignedIn();

      // 只允许教练创建邀请码
      allow create: if isSignedIn();

      // 允许教练更新自己的邀请码
      allow update: if isSignedIn() && resource.data.coachId == request.auth.uid;

      // 不允许删除邀请码
      allow delete: if false;
    }

    // ==================== Daily Trainings Collection ====================

    match /dailyTrainings/{trainingId} {
      // 允许教练读取他们管理的学生的训练记录
      // 允许学生读取自己的训练记录
      allow read: if isSignedIn() && (
        resource.data.coachID == request.auth.uid ||
        resource.data.studentID == request.auth.uid
      );

      // 允许学生创建和更新自己的训练记录
      allow create, update: if isSignedIn() &&
        request.resource.data.studentID == request.auth.uid;

      // 允许教练更新训练记录的审核状态和视频 isReviewed 字段
      allow update: if isSignedIn() &&
        resource.data.coachID == request.auth.uid;

      // 不允许删除训练记录
      allow delete: if false;
    }

    // ==================== Daily Training Feedback Collection ====================

    match /dailyTrainingFeedback/{feedbackId} {
      // 允许教练和学生获取单个反馈文档
      allow get: if isSignedIn() && (
        resource.data.coachId == request.auth.uid ||
        resource.data.studentId == request.auth.uid
      );

      // 允许教练和学生列表查询他们相关的反馈
      // 查询时必须包含 coachId 或 studentId 过滤条件
      allow list: if isSignedIn();

      // 只允许教练创建反馈
      allow create: if isSignedIn() &&
        request.resource.data.coachId == request.auth.uid;

      // 只允许教练更新反馈，或者学生标记为已读
      allow update: if isSignedIn() && (
        resource.data.coachId == request.auth.uid ||
        (resource.data.studentId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'updatedAt']))
      );

      // 允许教练删除反馈
      allow delete: if isSignedIn() &&
        resource.data.coachId == request.auth.uid;
    }

    // ==================== Body Measure Collection ====================

    match /bodyMeasure/{measureId} {
      // Helper function: 检查是否为学生本人或其教练
      function isStudentOrCoach(studentId) {
        return request.auth.uid == studentId ||
               get(/databases/$(database)/documents/users/$(studentId)).data.coachId == request.auth.uid;
      }

      // 允许学生读取自己的体重记录
      // 允许教练读取其管理的学生的体重记录
      allow read: if isSignedIn() && isStudentOrCoach(resource.data.studentID);

      // 只允许学生创建和更新自己的体重记录
      allow create, update: if isSignedIn() &&
        request.resource.data.studentID == request.auth.uid;

      // 不允许删除体重记录
      allow delete: if false;
    }

    // ==================== Exercise Templates Collection ====================

    match /exerciseTemplates/{templateId} {
      // 允许教练读取自己的动作模板
      allow read: if isSignedIn() && resource.data.ownerId == request.auth.uid;

      // 允许教练创建、更新、删除自己的动作模板
      allow create, update, delete: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
    }

    // ==================== Exercise Tags Subcollection ====================

    match /users/{userId}/exerciseTags/{tagId} {
      // 允许用户读取自己的标签
      allow read: if isSignedIn() && userId == request.auth.uid;

      // 允许用户创建、删除自己的标签
      allow create, delete: if isSignedIn() && userId == request.auth.uid;

      // 不允许更新标签（如需修改，删除后重建）
      allow update: if false;
    }

    // ==================== Default Deny ====================

    // 默认拒绝所有其他访问
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
