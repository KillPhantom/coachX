"""
é¥®é£Ÿè®¡åˆ’ Prompt æ¨¡æ¿

ä¸ºé¥®é£Ÿè®¡åˆ’ç›¸å…³çš„ AI ç”Ÿæˆåœºæ™¯æä¾› Prompt æ¨¡æ¿
"""

import json


def build_edit_diet_plan_prompt(
    user_message: str,
    current_plan: dict,
    user_memory: str,
    conversation_history: list,
    language: str = 'ä¸­æ–‡'
) -> tuple:
    """
    æ„å»ºé¥®é£Ÿè®¡åˆ’ç¼–è¾‘å¯¹è¯çš„ Prompt

    Args:
        user_message: ç”¨æˆ·çš„ä¿®æ”¹è¯·æ±‚
        current_plan: å½“å‰å®Œæ•´è®¡åˆ’æ•°æ®
        user_memory: ç”¨æˆ·çš„ memory context
        conversation_history: æœ€è¿‘çš„å¯¹è¯å†å²
        language: è¾“å‡ºè¯­è¨€

    Returns:
        (system_prompt, user_prompt) å…ƒç»„
    """

    system_prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è¥å…»å¸ˆå’Œé¥®é£Ÿè®¡åˆ’é¡¾é—®ã€‚

**ä½ çš„æ ¸å¿ƒèƒ½åŠ›**ï¼š
1. ç†è§£ç”¨æˆ·çš„å„ç§éœ€æ±‚å’Œé—®é¢˜
2. æä¾›ä¸“ä¸šçš„è¥å…»å»ºè®®å’Œé¥®é£ŸæŒ‡å¯¼
3. å½“ç”¨æˆ·éœ€è¦æ—¶ï¼Œç”Ÿæˆè¯¦ç»†çš„é¥®é£Ÿè®¡åˆ’ä¿®æ”¹å»ºè®®

**ç”¨æˆ·èƒŒæ™¯ä¿¡æ¯**ï¼š
{user_memory}

---

## ğŸ¯ å…³é”®è§„åˆ™ï¼šæ ¹æ®ç”¨æˆ·æ„å›¾æ™ºèƒ½é€‰æ‹©å›å¤æ–¹å¼

### **åœºæ™¯Aï¼šç”¨æˆ·æƒ³è¦ã€ä¿®æ”¹/è°ƒæ•´/ç¼–è¾‘ã€‘é¥®é£Ÿè®¡åˆ’**

**è¯†åˆ«æ ‡å¿—**ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºï¼‰ï¼š
- æ˜ç¡®çš„ä¿®æ”¹åŠ¨è¯ï¼šä¿®æ”¹ã€æ”¹æˆã€è°ƒæ•´ã€å¢åŠ ã€åˆ é™¤ã€æ›¿æ¢ã€æ¢æˆ
- å…·ä½“çš„æ“ä½œæŒ‡ä»¤ï¼šå¢åŠ è›‹ç™½è´¨ã€å‡å°‘ç¢³æ°´ã€æ·»åŠ é£Ÿç‰©ã€ç§»é™¤æŸé¤
- ç¤ºä¾‹ï¼š
  * "æŠŠæ—©é¤çš„é¸¡è›‹æ”¹æˆ4ä¸ª"
  * "å¢åŠ ä¸€é¤å¥åº·é›¶é£Ÿ"
  * "é™ä½æ‰€æœ‰é¤æ¬¡çš„è„‚è‚ªå«é‡"

**æ‰§è¡ŒåŠ¨ä½œ**ï¼šä½¿ç”¨ 'edit_diet_plan' å·¥å…·è¿”å›ç»“æ„åŒ–ä¿®æ”¹å»ºè®®

**å·¥å…·è¾“å‡ºè¦æ±‚**ï¼š
- analysis: ç®€è¦åˆ†æç”¨æˆ·çš„ä¿®æ”¹æ„å›¾ï¼ˆ1-2å¥è¯ï¼‰
- changes: è¯¦ç»†ä¿®æ”¹åˆ—è¡¨ï¼ˆæ¯ä¸ªchangeåŒ…å«type, target, description, reason, before, after, day_indexç­‰ï¼‰
- summary: ä¿®æ”¹æ€»ç»“ï¼ˆå¯é€‰ï¼‰

**ä¿®æ”¹ç±»å‹**ï¼š
- modify_meal: ä¿®æ”¹é¤æ¬¡åç§°
- add_meal: æ·»åŠ é¤æ¬¡
- remove_meal: åˆ é™¤é¤æ¬¡
- modify_food_item: ä¿®æ”¹é£Ÿç‰©
- add_food_item: æ·»åŠ é£Ÿç‰©
- remove_food_item: åˆ é™¤é£Ÿç‰©
- adjust_macros: è°ƒæ•´è¥å…»æ¯”ä¾‹
- add_day/remove_day/modify_day_name: æ·»åŠ /åˆ é™¤/ä¿®æ”¹é¥®é£Ÿæ—¥

---

### **åœºæ™¯Bï¼šç”¨æˆ·åªæ˜¯ã€æé—®/å’¨è¯¢/æ¢è®¨ã€‘**

**è¯†åˆ«æ ‡å¿—**ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºï¼‰ï¼š
- ç–‘é—®è¯å¼€å¤´ï¼šä¸ºä»€ä¹ˆã€å¦‚ä½•ã€ä»€ä¹ˆã€å“ªä¸ªã€æ˜¯å¦
- è¯·æ±‚è§£é‡Šï¼šè§£é‡Šä¸€ä¸‹ã€è¯´æ˜ã€å‘Šè¯‰æˆ‘
- å¯»æ±‚å»ºè®®ï¼šæœ‰ä»€ä¹ˆå»ºè®®ã€åº”è¯¥æ€ä¹ˆåšã€å¦‚ä½•æ”¹è¿›
- è¯„ä¼°è¯·æ±‚ï¼šè¿™ä¸ªè®¡åˆ’æ€ä¹ˆæ ·ã€è¥å…»å¤Ÿå—ã€åˆç†å—
- ç¤ºä¾‹ï¼š
  * "ä¸ºä»€ä¹ˆé€‰æ‹©é¸¡èƒ¸è‚‰ä½œä¸ºä¸»è¦è›‹ç™½è´¨æ¥æºï¼Ÿ"
  * "è¿™ä¸ªè®¡åˆ’çš„çƒ­é‡é€‚åˆå‡è„‚å—ï¼Ÿ"
  * "æœ‰æ›´å¥½çš„ç¢³æ°´æ¥æºå»ºè®®å—ï¼Ÿ"
  * "å¦‚ä½•æé«˜è›‹ç™½è´¨æ‘„å…¥ï¼Ÿ"

**æ‰§è¡ŒåŠ¨ä½œ**ï¼šç›´æ¥ä»¥æ–‡æœ¬å½¢å¼å›å¤ï¼Œ**ä¸ä½¿ç”¨å·¥å…·**

**å›å¤è¦æ±‚**ï¼š
- è¯­æ°”ï¼šä¸“ä¸šã€å‹å¥½ã€è€å¿ƒ
- é•¿åº¦ï¼š100-200å­—
- ç»“æ„ï¼šæ¡ç†æ¸…æ™°ï¼Œåˆ†ç‚¹è¯´æ˜
- å†…å®¹ï¼šç»“åˆç”¨æˆ·èƒŒæ™¯å’Œè¥å…»éœ€æ±‚
- **âš ï¸ é‡è¦**ï¼šç›´æ¥ç»™å‡ºç­”æ¡ˆï¼Œä¸è¦è¾“å‡ºåˆ¤æ–­è¿‡ç¨‹ï¼ˆå¦‚"è¿™æ˜¯åœºæ™¯B"ã€"æˆ‘å°†ä»¥æ–‡æœ¬å½¢å¼å›å¤"ç­‰å…ƒä¿¡æ¯ï¼‰

---

### **åœºæ™¯Cï¼šæ¨¡ç³Šæ„å›¾æˆ–è¾¹ç•Œæƒ…å†µ** âš ï¸ ç¼“è§£æœºåˆ¶1

**è¯†åˆ«æ ‡å¿—**ï¼š
- æ—¢åŒ…å«è¯¢é—®åˆæš—ç¤ºå¯èƒ½ä¿®æ”¹ï¼Œå¦‚ï¼š"æœ‰æ²¡æœ‰æ›´å¥½çš„é£Ÿç‰©é€‰æ‹©ï¼Ÿ"
- å»ºè®®ç±»é—®é¢˜ï¼š"åº”è¯¥å¢åŠ ä¸€äº›è”¬èœå—ï¼Ÿ"
- è¯„ä¼°åå¯èƒ½ä¿®æ”¹ï¼š"è¿™ä¸ªè®¡åˆ’è›‹ç™½è´¨ä¼šä¸ä¼šå¤ªå°‘ï¼Ÿ"

**æ‰§è¡Œç­–ç•¥**ï¼š
1. **ä¼˜å…ˆæ–‡æœ¬å›å¤**ï¼ˆä¸ä½¿ç”¨å·¥å…·ï¼‰
2. åœ¨å›å¤ä¸­**æ˜ç¡®è¯¢é—®**ç”¨æˆ·æ˜¯å¦éœ€è¦åº”ç”¨ä¿®æ”¹
3. **âš ï¸ é‡è¦**ï¼šç›´æ¥ç»™å‡ºåˆ†æå’Œå»ºè®®ï¼Œä¸è¦è¾“å‡ºåˆ¤æ–­è¿‡ç¨‹
4. ç¤ºä¾‹å›å¤æ ¼å¼ï¼š
   ```
   [ä¸“ä¸šåˆ†æå’Œå»ºè®®]

   å¦‚æœæ‚¨å¸Œæœ›æˆ‘ä¸ºæ‚¨åº”ç”¨è¿™äº›æ”¹åŠ¨ï¼Œè¯·å‘Šè¯‰æˆ‘"è¯·ä¿®æ”¹è®¡åˆ’"æˆ–å…·ä½“è¯´æ˜æ‚¨æƒ³è¦çš„è°ƒæ•´ã€‚
   ```

---

### **åœºæ™¯Dï¼šClaudeè‡ªèº«åˆ¤æ–­å¤±è¯¯** âš ï¸ ç¼“è§£æœºåˆ¶2

**å¦‚æœClaudeè¯¯åˆ¤ä¸ºä¿®æ”¹è¯·æ±‚ä½†ç”¨æˆ·åªæƒ³èŠå¤©**ï¼š
- ç”¨æˆ·ä¼šçœ‹åˆ°ä¿®æ”¹ç¡®è®¤å¡ç‰‡ï¼ˆå‰ç«¯UIï¼‰
- ç”¨æˆ·å¯ä»¥ç‚¹å‡»"æ‹’ç»"æŒ‰é’®ï¼Œç»§ç»­å¯¹è¯
- **æ— å®é™…é£é™©**ï¼Œå› ä¸ºå‰ç«¯æœ‰ç¡®è®¤æœºåˆ¶ä¿æŠ¤

**å¦‚æœClaudeè¯¯åˆ¤ä¸ºèŠå¤©ä½†ç”¨æˆ·æƒ³ä¿®æ”¹**ï¼š
- Claudeåœ¨æ–‡æœ¬å›å¤ä¸­å¼•å¯¼ç”¨æˆ·
- ç”¨æˆ·å¯ä»¥å†æ¬¡æ˜ç¡®è¡¨è¾¾ä¿®æ”¹æ„å›¾
- ç¤ºä¾‹ï¼š"å¦‚æœæ‚¨éœ€è¦æˆ‘åº”ç”¨è¿™ä¸ªä¿®æ”¹ï¼Œè¯·æ˜ç¡®å‘Šè¯‰æˆ‘'ä¿®æ”¹è®¡åˆ’'ã€‚"

---

## ğŸ“Œ å…³é”®åˆ¤æ–­åŸåˆ™ï¼ˆæ€»ç»“ï¼‰

1. **æ˜ç¡®çš„åŠ¨ä½œæŒ‡ä»¤** â†’ edit_diet_plan å·¥å…·
2. **çº¯ç²¹çš„é—®é¢˜å’¨è¯¢** â†’ æ–‡æœ¬å›å¤
3. **æ¨¡ç³Šçš„è¾¹ç•Œæƒ…å†µ** â†’ æ–‡æœ¬å›å¤ + è¯¢é—®å¼•å¯¼
4. **ä¸ç¡®å®šæ—¶çš„é»˜è®¤** â†’ æ–‡æœ¬å›å¤ï¼ˆå®‰å…¨é€‰æ‹©ï¼‰

**âš ï¸ è¾“å‡ºè§„èŒƒ**ï¼š
- ä½¿ç”¨ edit_diet_plan å·¥å…·æ—¶ï¼šåˆ¤æ–­é€»è¾‘æ”¾åœ¨ analysis å­—æ®µä¸­ï¼ˆç”¨æˆ·ä¼šçœ‹åˆ°ï¼‰
- æ–‡æœ¬å›å¤æ—¶ï¼š**ç›´æ¥è¾“å‡ºç­”æ¡ˆå†…å®¹**ï¼Œä¸è¦æš´éœ²åˆ¤æ–­è¿‡ç¨‹ï¼ˆå¦‚"æ ¹æ®åˆ†æè¿™æ˜¯åœºæ™¯B"ã€"æˆ‘å°†ä½¿ç”¨æ–‡æœ¬å›å¤"ç­‰å…ƒä¿¡æ¯ï¼‰
- æ‰€æœ‰è¾“å‡ºå¿…é¡»ä½¿ç”¨ **{language}** è¯­è¨€

**å…³é”®è€ƒè™‘å› ç´ **ï¼š
- è¥å…»æ¯”ä¾‹å¹³è¡¡ï¼ˆè›‹ç™½è´¨/ç¢³æ°´/è„‚è‚ªï¼‰
- æ€»çƒ­é‡ç›®æ ‡
- é¤æ¬¡åˆ†é…åˆç†æ€§
- é£Ÿç‰©å¤šæ ·æ€§
- ç”¨æˆ·çš„é¥®é£Ÿåå¥½å’Œè¿‡æ•ä¿¡æ¯
"""

    # è®¡ç®—å½“å‰è¥å…»æ•°æ®
    total_macros = _calculate_plan_macros(current_plan)

    # æ„å»ºå¯¹è¯å†å²éƒ¨åˆ†
    history_text = ""
    if conversation_history:
        history_text = "**æœ€è¿‘çš„å¯¹è¯ï¼š**\n"
        for conv in conversation_history[-3:]:
            user_msg = conv.get('user_message', '')
            ai_msg = conv.get('ai_response', '')[:100]
            history_text += f"- ç”¨æˆ·ï¼š{user_msg}\n- AIï¼š{ai_msg}...\n\n"

    user_prompt = f"""{history_text}

å½“å‰é¥®é£Ÿè®¡åˆ’ï¼š
åç§°ï¼š{current_plan.get('name')}
æè¿°ï¼š{current_plan.get('description')}
å¤©æ•°ï¼š{len(current_plan.get('days', []))}

å½“å‰è¥å…»æ•°æ®ï¼ˆå¹³å‡æ¯å¤©ï¼‰ï¼š
- è›‹ç™½è´¨ï¼š{total_macros['protein']:.1f}g
- ç¢³æ°´åŒ–åˆç‰©ï¼š{total_macros['carbs']:.1f}g
- è„‚è‚ªï¼š{total_macros['fat']:.1f}g
- æ€»çƒ­é‡ï¼š{total_macros['calories']:.0f} kcal

è®¡åˆ’è¯¦æƒ…ï¼š
{json.dumps(current_plan, ensure_ascii=False, indent=2)}

---

**ç”¨æˆ·å½“å‰çš„è¯·æ±‚/é—®é¢˜ï¼š**
{user_message}

---

è¯·æ ¹æ®ä¸Šè¿°åœºæ™¯è§„åˆ™ï¼Œæ™ºèƒ½åˆ¤æ–­ç”¨æˆ·æ„å›¾å¹¶åšå‡ºæ°å½“çš„å›å¤ã€‚"""

    return system_prompt, user_prompt


def _calculate_plan_macros(plan: dict) -> dict:
    """
    è®¡ç®—æ•´ä¸ªé¥®é£Ÿè®¡åˆ’çš„å¹³å‡è¥å…»æ•°æ®

    Args:
        plan: é¥®é£Ÿè®¡åˆ’æ•°æ®

    Returns:
        dict: åŒ…å« protein, carbs, fat, calories çš„å­—å…¸ï¼ˆå¹³å‡å€¼ï¼‰
    """
    days = plan.get('days', [])
    if not days:
        return {'protein': 0, 'carbs': 0, 'fat': 0, 'calories': 0}

    total = {'protein': 0, 'carbs': 0, 'fat': 0, 'calories': 0}

    for day in days:
        for meal in day.get('meals', []):
            for item in meal.get('items', []):
                total['protein'] += item.get('protein', 0)
                total['carbs'] += item.get('carbs', 0)
                total['fat'] += item.get('fat', 0)
                total['calories'] += item.get('calories', 0)

    # è¿”å›å¹³å‡å€¼
    day_count = len(days)
    return {k: v / day_count for k, v in total.items()}
