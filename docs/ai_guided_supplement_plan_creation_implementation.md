# AIå¼•å¯¼åˆ›å»ºè¡¥å‰‚è®¡åˆ’ - å®æ–½æ–‡æ¡£

**åˆ›å»ºæ—¥æœŸ**: 2025-01-02
**æœ€åæ›´æ–°**: 2025-01-02
**åŠŸèƒ½**: AIå¯¹è¯å¼åˆ›å»ºè¡¥å‰‚è®¡åˆ’ï¼ˆåŸºäºè®­ç»ƒå’Œé¥®é£Ÿè®¡åˆ’ï¼‰
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­ (81%å®Œæˆ)

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°ä½¿ç”¨Claude AIé€šè¿‡å¯¹è¯æ–¹å¼ç”Ÿæˆè¡¥å‰‚è®¡åˆ’çš„åŠŸèƒ½ã€‚ç”¨æˆ·é€šè¿‡ä¸¤æ­¥é€‰æ‹©æµç¨‹ï¼ˆè®­ç»ƒè®¡åˆ’ â†’ é¥®é£Ÿè®¡åˆ’ï¼‰æˆ–å•æ­¥é€‰æ‹©ï¼Œè®©AIåŸºäºç°æœ‰è®¡åˆ’æ¨èè¡¥å‰‚æ–¹æ¡ˆã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¯¹è¯å¼äº¤äº’**ï¼šæ‰€æœ‰é€‰æ‹©å’Œäº¤äº’åœ¨chatå¯¹è¯å†…å®Œæˆ
- âœ… **ä¸¤æ­¥é€‰æ‹©æµç¨‹**ï¼šå…ˆé€‰è®­ç»ƒè®¡åˆ’ï¼Œå†é€‰é¥®é£Ÿè®¡åˆ’
- âœ… **å•æ­¥é€‰æ‹©æ”¯æŒ**ï¼šä»…æ ¹æ®è®­ç»ƒè®¡åˆ’æˆ–ä»…æ ¹æ®é¥®é£Ÿè®¡åˆ’æ¨è
- âœ… **åŸºäºç°æœ‰è®¡åˆ’**ï¼šä½¿ç”¨`_get_plan()`å’Œ`_get_diet_plan()`è·å–å®Œæ•´æ•°æ®
- âœ… **æµå¼ç”Ÿæˆ**ï¼šSSEå®æ—¶æ¨é€AIæ€è€ƒè¿‡ç¨‹
- âœ… **é»˜è®¤ç”Ÿæˆä¸€å¤©**ï¼ševeryday sameï¼ˆæ‰€æœ‰å¤©å¤ç”¨åŒä¸€æ–¹æ¡ˆï¼‰

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æŠ€æœ¯æ ˆ

**åç«¯:**
- Python Cloud Functions (Firebase 2nd gen)
- Claude API with Streaming
- Firestore (è·å–ç°æœ‰plans)

**å‰ç«¯:**
- Flutter + Cupertino UI (70% height modal sheet)
- Riverpod 2.x (çŠ¶æ€ç®¡ç†)
- SSEæµå¼å¤„ç†

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒæµç¨‹

```
ç”¨æˆ·ç‚¹å‡» âœ¨ SparkleæŒ‰é’®ï¼ˆéç¼–è¾‘æ¨¡å¼ï¼‰
    â†“
70% Sheetå¼¹å‡ºï¼Œæ˜¾ç¤ºAIæ¬¢è¿æ¶ˆæ¯
    â†“
å¿«æ·é€‰é¡¹æ˜¾ç¤ºï¼š
  â€¢ [å›¾æ ‡] æ ¹æ®è®­ç»ƒå’Œé¥®é£Ÿè®¡åˆ’æ¨è â† ä¸¤æ­¥é€‰æ‹©
  â€¢ [å›¾æ ‡] ä»…æ ¹æ®è®­ç»ƒè®¡åˆ’æ¨è      â† å•æ­¥é€‰æ‹©
  â€¢ [å›¾æ ‡] ä»…æ ¹æ®é¥®é£Ÿè®¡åˆ’æ¨è      â† å•æ­¥é€‰æ‹©
  â€¢ [å›¾æ ‡] åŸºç¡€å¥—é¤                â† æ— éœ€é€‰æ‹©
    â†“
ã€åœºæ™¯1ï¼šä¸¤æ­¥é€‰æ‹©ã€‘
ç”¨æˆ·ç‚¹å‡»"æ ¹æ®è®­ç»ƒå’Œé¥®é£Ÿè®¡åˆ’æ¨è"
    â†“
[User] "æ ¹æ®è®­ç»ƒå’Œé¥®é£Ÿè®¡åˆ’æ¨è"
    â†“
[AI] "å¥½çš„ï¼é¦–å…ˆè¯·é€‰æ‹©è®­ç»ƒè®¡åˆ’ï¼š"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ å¢è‚Œè®­ç»ƒè®¡åˆ’ A           â”‚ â† å¯ç‚¹å‡»å¡ç‰‡
â”‚ 5å¤© Â· åˆ›å»ºäº2025-01-15      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ å‡è„‚è®­ç»ƒè®¡åˆ’ B           â”‚
â”‚ 4å¤© Â· åˆ›å»ºäº2025-01-10      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ç”¨æˆ·ç‚¹å‡»
[User] "æˆ‘é€‰æ‹©ã€Œå¢è‚Œè®­ç»ƒè®¡åˆ’Aã€"
    â†“
[AI] "å¾ˆå¥½ï¼æ¥ä¸‹æ¥è¯·é€‰æ‹©é¥®é£Ÿè®¡åˆ’ï¼š"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ½ï¸ å¢è‚Œé¥®é£Ÿè®¡åˆ’ A           â”‚
â”‚ 7å¤© Â· åˆ›å»ºäº2025-01-15      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ç”¨æˆ·ç‚¹å‡»
[User] "æˆ‘é€‰æ‹©ã€Œå¢è‚Œé¥®é£Ÿè®¡åˆ’Aã€"
    â†“
[AI] "æ­£åœ¨åˆ†ææ‚¨çš„è®­ç»ƒå¼ºåº¦å’Œè¥å…»æ‘„å…¥..."
    â†“
[AI] "æˆ‘ä¸ºæ‚¨æ¨èä»¥ä¸‹è¡¥å‰‚æ–¹æ¡ˆï¼š"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ å»ºè®®çš„è¡¥å‰‚æ–¹æ¡ˆï¼ˆ1å¤©ï¼‰    â”‚
â”‚ â”€â”€ æ—©é¤å‰ â”€â”€                â”‚
â”‚ â€¢ è‚Œé…¸ 5g                   â”‚
â”‚ â”€â”€ è®­ç»ƒå â”€â”€                â”‚
â”‚ â€¢ è›‹ç™½ç²‰ 30g                â”‚
â”‚ â€¢ BCAA 10g                  â”‚
â”‚ â”€â”€ ç¡å‰ â”€â”€                  â”‚
â”‚ â€¢ é…ªè›‹ç™½ 25g                â”‚
â”‚                             â”‚
â”‚ [é¢„è§ˆ] [æ‹’ç»] [åº”ç”¨]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ç”¨æˆ·ç‚¹å‡»[åº”ç”¨]
Sheetå…³é—­ï¼Œè¡¥å‰‚è®¡åˆ’é¡µé¢æ˜¾ç¤ºç”Ÿæˆçš„è®¡åˆ’ï¼ˆæ‰€æœ‰å¤©å¤ç”¨åŒä¸€æ–¹æ¡ˆï¼‰
```

---

## ğŸ“‚ æ–‡ä»¶æ¸…å•

### åç«¯æ–°å¢/ä¿®æ”¹æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

#### 1. `functions/ai/tools.py` âœï¸ ä¿®æ”¹

**æ–°å¢å‡½æ•°**: `get_supplement_day_tool()`

```python
def get_supplement_day_tool() -> Dict[str, Any]:
    """
    è·å–è¡¥å‰‚æ—¥å·¥å…·å®šä¹‰

    ç”¨äº Claude Tool Useï¼Œè¿”å›å•å¤©çš„è¡¥å‰‚æ–¹æ¡ˆ

    Returns:
        Tool å®šä¹‰å­—å…¸
    """
    return {
        "name": "create_supplement_day",
        "description": "åˆ›å»ºä¸€å¤©çš„è¡¥å‰‚æ–¹æ¡ˆï¼ˆeveryday sameï¼‰ï¼ŒåŒ…å«å„ä¸ªæ—¶é—´æ®µçš„è¡¥å‰‚é…ç½®",
        "input_schema": {
            "type": "object",
            "properties": {
                "analysis": {
                    "type": "string",
                    "description": "å¯¹ç”¨æˆ·éœ€æ±‚å’Œè®­ç»ƒ/é¥®é£Ÿè®¡åˆ’çš„åˆ†æ"
                },
                "day_name": {
                    "type": "string",
                    "description": "è¡¥å‰‚æ—¥åç§°ï¼Œå¦‚ 'æ ‡å‡†è¡¥å‰‚æ—¥', 'Standard Supplement Day'"
                },
                "timings": {
                    "type": "array",
                    "description": "è¡¥å‰‚æ—¶é—´æ®µåˆ—è¡¨",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {
                                "type": "string",
                                "description": "æ—¶é—´æ®µåç§°ï¼Œå¦‚ 'æ—©é¤å‰', 'è®­ç»ƒå', 'ç¡å‰'"
                            },
                            "note": {
                                "type": "string",
                                "description": "æ—¶é—´æ®µå¤‡æ³¨ï¼Œå¦‚ 'ç©ºè…¹æœç”¨æ•ˆæœæ›´ä½³'"
                            },
                            "supplements": {
                                "type": "array",
                                "description": "è¯¥æ—¶é—´æ®µçš„è¡¥å‰‚åˆ—è¡¨",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "name": {
                                            "type": "string",
                                            "description": "è¡¥å‰‚åç§°ï¼Œå¦‚ 'è›‹ç™½ç²‰', 'è‚Œé…¸', 'BCAA'"
                                        },
                                        "amount": {
                                            "type": "string",
                                            "description": "ç”¨é‡ï¼Œå¦‚ '30g', '5g', '10g'"
                                        }
                                    },
                                    "required": ["name", "amount"]
                                },
                                "minItems": 1
                            }
                        },
                        "required": ["name", "supplements"]
                    },
                    "minItems": 1
                },
                "summary": {
                    "type": "string",
                    "description": "è¡¥å‰‚æ–¹æ¡ˆæ€»ç»“ï¼Œè¯´æ˜æ¨èç†ç”±"
                }
            },
            "required": ["analysis", "day_name", "timings"]
        }
    }
```

---

#### 2. `functions/ai/supplement_plan/prompts.py` âœ¨ æ–°å»ºæ–‡ä»¶

**åŠŸèƒ½**: æ„å»ºè¡¥å‰‚æ¨èçš„system promptå’Œuser prompt

```python
"""
è¡¥å‰‚è®¡åˆ’ç”Ÿæˆ Prompt æ¨¡å—

æ„å»º Claude API ä½¿ç”¨çš„ system prompt å’Œ user prompt
"""

from typing import Dict, Any, Optional, List, Tuple


def get_system_prompt(language: str = 'ä¸­æ–‡') -> str:
    """
    è·å–è¡¥å‰‚æ¨èä¸“å®¶çš„ system prompt

    Args:
        language: è¾“å‡ºè¯­è¨€

    Returns:
        System prompt å­—ç¬¦ä¸²
    """
    return f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è¿åŠ¨è¥å…»å¸ˆå’Œè¡¥å‰‚æ¨èä¸“å®¶ã€‚

ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„è®­ç»ƒè®¡åˆ’ã€é¥®é£Ÿè®¡åˆ’å’Œä¸ªäººéœ€æ±‚ï¼Œæ¨èç§‘å­¦åˆç†çš„è¡¥å‰‚æ–¹æ¡ˆã€‚

## å…³é”®åŸåˆ™

1. **åŸºäºå®é™…éœ€æ±‚**ï¼šåˆ†æè®­ç»ƒå¼ºåº¦å’Œè¥å…»ç¼ºå£ï¼Œæ¨èå¿…è¦çš„è¡¥å‰‚
2. **å‰‚é‡ç§‘å­¦**ï¼šéµå¾ªè¿åŠ¨è¥å…»å­¦ç ”ç©¶çš„æ¨èå‰‚é‡
3. **æœç”¨æ—¶æœº**ï¼šä¼˜åŒ–è¡¥å‰‚å¸æ”¶æ•ˆæœçš„æ—¶é—´å®‰æ’
4. **æˆæœ¬è€ƒè™‘**ï¼šä¼˜å…ˆæ¨èæ€§ä»·æ¯”é«˜çš„åŸºç¡€è¡¥å‰‚
5. **å®‰å…¨ç¬¬ä¸€**ï¼šé¿å…æ¨èæœ‰äº‰è®®æˆ–é£é™©çš„è¡¥å‰‚

## è¡¥å‰‚ç±»åˆ«ä¼˜å…ˆçº§

1. **åŸºç¡€ç±»**ï¼ˆç§‘å­¦è¯æ®å……åˆ†ï¼‰
   - è›‹ç™½ç²‰ï¼ˆWhey Proteinï¼‰ï¼šè®­ç»ƒåè‚Œè‚‰ä¿®å¤
   - è‚Œé…¸ï¼ˆCreatineï¼‰ï¼šå¢å¼ºåŠ›é‡å’Œè‚Œè‚‰å¢é•¿
   - ç»´ç”Ÿç´ Dï¼šéª¨éª¼å¥åº·ã€å…ç–«åŠ›
   - Omega-3ï¼šæŠ—ç‚ã€å¿ƒè¡€ç®¡å¥åº·

2. **è®­ç»ƒç±»**ï¼ˆé’ˆå¯¹é«˜å¼ºåº¦è®­ç»ƒï¼‰
   - BCAAï¼šå‡å°‘è‚Œè‚‰åˆ†è§£
   - è°·æ°¨é…°èƒºï¼šåŠ é€Ÿæ¢å¤
   - å’–å•¡å› ï¼šæå‡è®­ç»ƒè¡¨ç°
   - æ°®æ³µï¼ˆPre-workoutï¼‰ï¼šå¢åŠ èƒ½é‡å’Œä¸“æ³¨åŠ›

3. **å¥åº·ç±»**ï¼ˆè¥å…»è¡¥å……ï¼‰
   - å¤šç§ç»´ç”Ÿç´ ï¼ˆMultivitaminï¼‰
   - ZMAï¼ˆé”Œ+é•ï¼‰ï¼šç¡çœ è´¨é‡
   - ç›Šç”ŸèŒï¼šè‚ é“å¥åº·

4. **å¯é€‰ç±»**ï¼ˆæ ¹æ®ç›®æ ‡å’Œé¢„ç®—ï¼‰
   - å¢è‚Œç²‰ï¼ˆMass Gainerï¼‰ï¼šå¢åŠ çƒ­é‡æ‘„å…¥
   - CLAï¼šè¾…åŠ©å‡è„‚
   - HMBï¼šå‡å°‘è‚Œè‚‰åˆ†è§£

## æœç”¨æ—¶æœºå»ºè®®

- **æ—©é¤å‰/ç©ºè…¹**ï¼šè‚Œé…¸ã€ç»´ç”Ÿç´ D
- **è®­ç»ƒå‰**ï¼šæ°®æ³µã€å’–å•¡å› 
- **è®­ç»ƒå**ï¼šè›‹ç™½ç²‰ã€BCAAã€è‚Œé…¸
- **ç¡å‰**ï¼šé…ªè›‹ç™½ï¼ˆCaseinï¼‰ã€ZMA
- **éšé¤**ï¼šå¤šç§ç»´ç”Ÿç´ ã€Omega-3

## è¾“å‡ºè¦æ±‚

1. å…ˆåˆ†æç”¨æˆ·çš„è®­ç»ƒå¼ºåº¦ã€é¢‘ç‡å’Œè¥å…»æ‘„å…¥æƒ…å†µ
2. è¯†åˆ«æ½œåœ¨çš„è¥å…»ç¼ºå£
3. æ¨èè¡¥å‰‚æ–¹æ¡ˆï¼ˆæŒ‰æ—¶é—´æ®µç»„ç»‡ï¼‰
4. è¯´æ˜æ¯ç§è¡¥å‰‚çš„ä½œç”¨å’Œæ¨èç†ç”±
5. **ä½¿ç”¨ {language} è¿›è¡Œå¯¹è¯å’Œç”Ÿæˆ**

è¯·è°ƒç”¨ create_supplement_day å·¥å…·è¿”å›ç»“æ„åŒ–çš„è¡¥å‰‚æ–¹æ¡ˆã€‚
"""


def build_supplement_creation_prompt(
    user_message: str,
    training_plan: Optional[Dict[str, Any]],
    diet_plan: Optional[Dict[str, Any]],
    conversation_history: List[Dict[str, str]],
    language: str = 'ä¸­æ–‡'
) -> Tuple[str, str]:
    """
    æ„å»ºè¡¥å‰‚æ–¹æ¡ˆåˆ›å»º prompt

    Args:
        user_message: ç”¨æˆ·çš„è¯·æ±‚æ¶ˆæ¯
        training_plan: è®­ç»ƒè®¡åˆ’æ•°æ®ï¼ˆå¯é€‰ï¼‰
        diet_plan: é¥®é£Ÿè®¡åˆ’æ•°æ®ï¼ˆå¯é€‰ï¼‰
        conversation_history: å¯¹è¯å†å²
        language: è¾“å‡ºè¯­è¨€

    Returns:
        (system_prompt, user_prompt) å…ƒç»„
    """
    system_prompt = get_system_prompt(language)

    # æ„å»ºä¸Šä¸‹æ–‡éƒ¨åˆ†
    context_sections = []

    # è®­ç»ƒè®¡åˆ’ä¸Šä¸‹æ–‡
    if training_plan:
        training_summary = _summarize_training_plan(training_plan)
        context_sections.append(f"""
## ç”¨æˆ·çš„è®­ç»ƒè®¡åˆ’

**è®¡åˆ’åç§°**: {training_plan.get('name', 'æœªå‘½å')}
**è®­ç»ƒé¢‘ç‡**: æ¯å‘¨ {len(training_plan.get('days', []))} å¤©
**è®­ç»ƒå¼ºåº¦**: {training_summary['intensity']}
**ä¸»è¦è®­ç»ƒç±»å‹**: {training_summary['training_types']}
**æ€»è®­ç»ƒé‡**: {training_summary['total_volume']}

è®­ç»ƒæ—¥è¯¦æƒ…:
{training_summary['days_detail']}
""")

    # é¥®é£Ÿè®¡åˆ’ä¸Šä¸‹æ–‡
    if diet_plan:
        diet_summary = _summarize_diet_plan(diet_plan)
        context_sections.append(f"""
## ç”¨æˆ·çš„é¥®é£Ÿè®¡åˆ’

**è®¡åˆ’åç§°**: {diet_plan.get('name', 'æœªå‘½å')}
**è¥å…»ç›®æ ‡**: {diet_summary['goal']}
**æ¯æ—¥çƒ­é‡**: {diet_summary['avg_calories']} kcalï¼ˆä¼°ç®—ï¼‰
**è›‹ç™½è´¨æ‘„å…¥**: {diet_summary['avg_protein']} g/å¤©ï¼ˆä¼°ç®—ï¼‰
**ç¢³æ°´åŒ–åˆç‰©**: {diet_summary['avg_carbs']} g/å¤©ï¼ˆä¼°ç®—ï¼‰
**è„‚è‚ª**: {diet_summary['avg_fat']} g/å¤©ï¼ˆä¼°ç®—ï¼‰

é¥®é£Ÿç‰¹ç‚¹:
{diet_summary['characteristics']}
""")

    # å¦‚æœæ²¡æœ‰è®¡åˆ’ï¼Œæä¾›é€šç”¨ä¸Šä¸‹æ–‡
    if not training_plan and not diet_plan:
        context_sections.append("""
## ç”¨æˆ·æƒ…å†µ

ç”¨æˆ·æœªæä¾›è®­ç»ƒè®¡åˆ’æˆ–é¥®é£Ÿè®¡åˆ’ã€‚è¯·åŸºäºç”¨æˆ·çš„æè¿°å’Œé€šç”¨å¥èº«å»ºè®®æ¨èè¡¥å‰‚æ–¹æ¡ˆã€‚
""")

    context = "\n".join(context_sections)

    # æ„å»º user prompt
    user_prompt = f"""{context}

## ç”¨æˆ·è¯·æ±‚

{user_message}

## ä»»åŠ¡

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆä¸€å¤©çš„è¡¥å‰‚æ–¹æ¡ˆï¼ˆeveryday sameï¼‰ã€‚æ–¹æ¡ˆåº”åŒ…å«ï¼š

1. **åˆ†æ**ï¼šç”¨æˆ·çš„è®­ç»ƒå¼ºåº¦ã€è¥å…»æ‘„å…¥æƒ…å†µå’Œæ½œåœ¨éœ€æ±‚
2. **æ¨èè¡¥å‰‚åˆ—è¡¨**ï¼šæŒ‰æœç”¨æ—¶é—´æ®µç»„ç»‡ï¼ˆå¦‚ï¼šæ—©é¤å‰ã€è®­ç»ƒåã€ç¡å‰ï¼‰
3. **å‰‚é‡è¯´æ˜**ï¼šæ¯ç§è¡¥å‰‚çš„ç§‘å­¦æ¨èå‰‚é‡
4. **æ¨èç†ç”±**ï¼šä¸ºä»€ä¹ˆæ¨èè¿™äº›è¡¥å‰‚

è¯·è°ƒç”¨ create_supplement_day å·¥å…·è¿”å›ç»“æ„åŒ–æ•°æ®ã€‚
"""

    return system_prompt, user_prompt


def _summarize_training_plan(plan: Dict[str, Any]) -> Dict[str, Any]:
    """
    æ€»ç»“è®­ç»ƒè®¡åˆ’çš„å…³é”®ä¿¡æ¯

    Args:
        plan: è®­ç»ƒè®¡åˆ’æ•°æ®

    Returns:
        è®­ç»ƒè®¡åˆ’æ‘˜è¦å­—å…¸
    """
    days = plan.get('days', [])

    # è®¡ç®—æ€»è®­ç»ƒé‡
    total_exercises = sum(len(day.get('exercises', [])) for day in days)
    total_sets = sum(
        len(exercise.get('sets', []))
        for day in days
        for exercise in day.get('exercises', [])
    )

    # åˆ†æè®­ç»ƒå¼ºåº¦ï¼ˆåŸºäºç»„æ•°ï¼‰
    avg_sets_per_day = total_sets / len(days) if days else 0
    if avg_sets_per_day > 20:
        intensity = 'é«˜å¼ºåº¦'
    elif avg_sets_per_day > 12:
        intensity = 'ä¸­ç­‰å¼ºåº¦'
    else:
        intensity = 'ä½å¼ºåº¦'

    # è¯†åˆ«è®­ç»ƒç±»å‹
    training_types = set()
    for day in days:
        day_type = day.get('type', '')
        if day_type:
            training_types.add(day_type)
        else:
            # æ ¹æ®åŠ¨ä½œåç§°æ¨æµ‹
            day_name = day.get('name', '').lower()
            if 'chest' in day_name or 'èƒ¸' in day_name:
                training_types.add('Chest')
            elif 'back' in day_name or 'èƒŒ' in day_name:
                training_types.add('Back')
            elif 'leg' in day_name or 'è…¿' in day_name:
                training_types.add('Legs')

    # æ„å»ºè®­ç»ƒæ—¥è¯¦æƒ…
    days_detail_lines = []
    for i, day in enumerate(days[:3], 1):  # åªæ˜¾ç¤ºå‰3å¤©
        day_name = day.get('name', f'Day {i}')
        exercises_count = len(day.get('exercises', []))
        days_detail_lines.append(f"- Day {i} ({day_name}): {exercises_count} ä¸ªåŠ¨ä½œ")

    if len(days) > 3:
        days_detail_lines.append(f"- ... å…± {len(days)} å¤©")

    return {
        'intensity': intensity,
        'training_types': ', '.join(training_types) if training_types else 'åŠ›é‡è®­ç»ƒ',
        'total_volume': f'{total_exercises} ä¸ªåŠ¨ä½œï¼Œ{total_sets} ç»„',
        'days_detail': '\n'.join(days_detail_lines)
    }


def _summarize_diet_plan(plan: Dict[str, Any]) -> Dict[str, Any]:
    """
    æ€»ç»“é¥®é£Ÿè®¡åˆ’çš„å…³é”®ä¿¡æ¯

    Args:
        plan: é¥®é£Ÿè®¡åˆ’æ•°æ®

    Returns:
        é¥®é£Ÿè®¡åˆ’æ‘˜è¦å­—å…¸
    """
    days = plan.get('days', [])

    # ä¼°ç®—å¹³å‡è¥å…»æ‘„å…¥ï¼ˆåŸºäºç¬¬ä¸€å¤©ï¼‰
    if days:
        first_day = days[0]
        meals = first_day.get('meals', [])

        # ç®€å•ä¼°ç®—ï¼ˆå®é™…éœ€è¦ç´¯åŠ æ‰€æœ‰food itemsçš„macrosï¼‰
        total_protein = 0
        total_carbs = 0
        total_fat = 0
        total_calories = 0

        for meal in meals:
            items = meal.get('items', [])
            for item in items:
                macros = item.get('macros', {})
                total_protein += macros.get('protein', 0)
                total_carbs += macros.get('carbs', 0)
                total_fat += macros.get('fat', 0)
                total_calories += macros.get('calories', 0)

        avg_protein = int(total_protein)
        avg_carbs = int(total_carbs)
        avg_fat = int(total_fat)
        avg_calories = int(total_calories)
    else:
        avg_protein = 0
        avg_carbs = 0
        avg_fat = 0
        avg_calories = 0

    # åˆ¤æ–­è¥å…»ç›®æ ‡
    if avg_calories > 2800:
        goal = 'å¢è‚Œ'
    elif avg_calories < 2000:
        goal = 'å‡è„‚'
    else:
        goal = 'ç»´æŒ'

    # åˆ†æé¥®é£Ÿç‰¹ç‚¹
    characteristics = []
    if avg_protein > 150:
        characteristics.append('- é«˜è›‹ç™½é¥®é£Ÿ')
    if avg_carbs > 300:
        characteristics.append('- é«˜ç¢³æ°´é¥®é£Ÿ')
    elif avg_carbs < 150:
        characteristics.append('- ä½ç¢³æ°´é¥®é£Ÿ')

    if not characteristics:
        characteristics.append('- å‡è¡¡é¥®é£Ÿ')

    return {
        'goal': goal,
        'avg_calories': avg_calories if avg_calories > 0 else 'æœªçŸ¥',
        'avg_protein': avg_protein if avg_protein > 0 else 'æœªçŸ¥',
        'avg_carbs': avg_carbs if avg_carbs > 0 else 'æœªçŸ¥',
        'avg_fat': avg_fat if avg_fat > 0 else 'æœªçŸ¥',
        'characteristics': '\n'.join(characteristics)
    }
```

---

#### 3. `functions/ai/streaming.py` âœï¸ ä¿®æ”¹

**æ–°å¢å‡½æ•°**: `stream_generate_supplement_plan_conversation()`

```python
def stream_generate_supplement_plan_conversation(
    user_id: str,
    user_message: str,
    training_plan: Optional[Dict[str, Any]],
    diet_plan: Optional[Dict[str, Any]],
    conversation_history: List[Dict[str, str]]
) -> Generator[Dict[str, Any], None, None]:
    """
    æµå¼å¤„ç†è¡¥å‰‚è®¡åˆ’ç”Ÿæˆå¯¹è¯

    Args:
        user_id: ç”¨æˆ·ID
        user_message: ç”¨æˆ·çš„è¯·æ±‚æ¶ˆæ¯
        training_plan: è®­ç»ƒè®¡åˆ’æ•°æ®ï¼ˆå¯é€‰ï¼‰
        diet_plan: é¥®é£Ÿè®¡åˆ’æ•°æ®ï¼ˆå¯é€‰ï¼‰
        conversation_history: å¯¹è¯å†å²

    Yields:
        dict: æµå¼äº‹ä»¶
            - type: 'thinking' | 'analysis' | 'suggestion' | 'complete' | 'error'
            - content: å†…å®¹ï¼ˆthinking å’Œ analysis æ—¶ï¼‰
            - data: æ•°æ®ï¼ˆsuggestion æ—¶ï¼ŒåŒ…å« SupplementDayï¼‰
            - error: é”™è¯¯ä¿¡æ¯ï¼ˆerror æ—¶ï¼‰
    """
    try:
        logger.info(f'ğŸ”„ [Supplement] å¼€å§‹å¤„ç†è¡¥å‰‚è®¡åˆ’å¯¹è¯ - User: {user_id}')
        logger.info(f'ç”¨æˆ·è¯·æ±‚: {user_message[:100]}...')

        # 1. è·å–ç”¨æˆ· memoryï¼ˆå¯é€‰ï¼Œç”¨äºè®°ä½ç”¨æˆ·åå¥½ï¼‰
        logger.info('ğŸ“– åŠ è½½ç”¨æˆ· Memory')
        from .memory_manager import MemoryManager
        profile = MemoryManager.get_user_memory(user_id)
        language = profile.language_preference

        logger.info(f'ğŸŒ è¯­è¨€è®¾ç½®: {language}')

        # å‘é€æ€è€ƒäº‹ä»¶
        yield {
            'type': 'thinking',
            'content': 'æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚...'
        }

        # 2. æ„å»º Prompt
        logger.info('ğŸ“ æ„å»ºè¡¥å‰‚è®¡åˆ’ç”Ÿæˆ Prompt')
        from .supplement_plan.prompts import build_supplement_creation_prompt

        system_prompt, user_prompt = build_supplement_creation_prompt(
            user_message=user_message,
            training_plan=training_plan,
            diet_plan=diet_plan,
            conversation_history=conversation_history,
            language=language
        )

        logger.info(f'System Prompt é•¿åº¦: {len(system_prompt)} å­—ç¬¦')
        logger.info(f'User Prompt é•¿åº¦: {len(user_prompt)} å­—ç¬¦')

        # 3. è°ƒç”¨ Claude Streaming API
        logger.info('ğŸ”„ å¼€å§‹è°ƒç”¨ Claude Streaming API')
        from .claude_client import get_claude_client
        from .tools import get_supplement_day_tool

        claude_client = get_claude_client()
        tool = get_supplement_day_tool()
        tools = [tool]

        tool_input = None
        text_content = ""
        event_count = 0

        for event in claude_client.call_claude_streaming(
            system_prompt=system_prompt,
            user_prompt=user_prompt,
            tools=tools
        ):
            event_count += 1
            event_type = event.get('type')
            logger.debug(f'ğŸ“¨ [Supplement Event #{event_count}] type={event_type}')

            # æ–‡æœ¬å†…å®¹ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰
            if event_type == 'text_delta':
                text_delta = event.get('text', '')
                text_content += text_delta
                logger.debug(f'ğŸ“ text_deltaé•¿åº¦: {len(text_delta)}')

                if text_delta:
                    yield {
                        'type': 'thinking',
                        'content': text_delta
                    }

            # Tool è°ƒç”¨å¼€å§‹
            elif event_type == 'tool_start':
                tool_name = event.get('tool_name')
                logger.info(f'ğŸ”§ Tool è°ƒç”¨å¼€å§‹: {tool_name}')

                yield {
                    'type': 'analysis',
                    'content': 'æ­£åœ¨ç”Ÿæˆè¡¥å‰‚æ–¹æ¡ˆ...'
                }

            # Tool è°ƒç”¨å®Œæˆ
            elif event_type == 'tool_complete':
                tool_input = event.get('tool_input', {})
                logger.info('âœ… Tool è°ƒç”¨å®Œæˆ')
                logger.debug(f'Tool è¾“å‡º: {json.dumps(tool_input, ensure_ascii=False, indent=2)[:500]}...')

                # æå–è¡¥å‰‚æ–¹æ¡ˆæ•°æ®
                analysis = tool_input.get('analysis', '')
                day_name = tool_input.get('day_name', 'æ ‡å‡†è¡¥å‰‚æ—¥')
                timings = tool_input.get('timings', [])
                summary = tool_input.get('summary', '')

                logger.info(f'ğŸ“Š Tool è¾“å‡ºå­—æ®µæ£€æŸ¥:')
                logger.info(f'  - analysis: {"âœ…" if analysis else "âŒ"} ({len(analysis)} å­—ç¬¦)')
                logger.info(f'  - day_name: {day_name}')
                logger.info(f'  - timings: {"âœ…" if timings else "âŒ"} ({len(timings)} ä¸ªæ—¶é—´æ®µ)')
                logger.info(f'  - summary: {"âœ…" if summary else "âŒ"} ({len(summary)} å­—ç¬¦)')

                # å‘é€åˆ†æç»“æœ
                if analysis:
                    yield {
                        'type': 'analysis',
                        'content': analysis
                    }

                # æ„å»º SupplementDay æ•°æ®
                supplement_day_data = {
                    'day': 1,
                    'name': day_name,
                    'timings': timings,
                    'completed': False
                }

                # å‘é€è¡¥å‰‚æ–¹æ¡ˆå»ºè®®
                yield {
                    'type': 'suggestion',
                    'data': {
                        'supplement_day': supplement_day_data,
                        'summary': summary
                    }
                }

            elif event_type == 'error':
                error_msg = event.get('error', 'æœªçŸ¥é”™è¯¯')
                logger.error(f'âŒ Claude API è¿”å›é”™è¯¯: {error_msg}')
                raise Exception(error_msg)

        logger.info(f'ğŸ“Š å…±æ”¶åˆ° {event_count} ä¸ªäº‹ä»¶')

        # æ£€æŸ¥æ˜¯å¦ä¸ºçº¯æ–‡æœ¬å“åº”
        if not tool_input and text_content:
            logger.info('ğŸ“ æ£€æµ‹åˆ°çº¯æ–‡æœ¬å“åº”')
            yield {
                'type': 'analysis',
                'content': text_content
            }

        # ä¿å­˜å¯¹è¯å†å²
        logger.info('ğŸ’¾ ä¿å­˜å¯¹è¯å†å²åˆ° Memory')
        ai_response_summary = tool_input.get('summary', '') if tool_input else text_content[:200]
        MemoryManager.update_conversation_history(
            user_id=user_id,
            user_message=user_message,
            ai_response=ai_response_summary,
            context={'type': 'supplement_creation'}
        )

        # å®Œæˆ
        logger.info('ğŸ‰ è¡¥å‰‚è®¡åˆ’å¯¹è¯å¤„ç†å®Œæˆ')
        yield {
            'type': 'complete',
            'message': 'è¡¥å‰‚æ–¹æ¡ˆå·²ç”Ÿæˆ'
        }

    except Exception as e:
        logger.error(f'âŒ è¡¥å‰‚è®¡åˆ’å¯¹è¯å¤„ç†å¤±è´¥: {str(e)}', exc_info=True)
        yield {
            'type': 'error',
            'error': f'å¤„ç†å¤±è´¥: {str(e)}'
        }
```

---

#### 4. `functions/ai/handlers.py` âœï¸ ä¿®æ”¹

**æ–°å¢å‡½æ•°**: `generate_supplement_plan_conversation`

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š

```python
@https_fn.on_request(cors=cors)
def generate_supplement_plan_conversation(req: https_fn.Request):
    """
    è¡¥å‰‚è®¡åˆ’å¯¹è¯ç”Ÿæˆï¼ˆSSEæµå¼ï¼‰

    HTTP POST /generate_supplement_plan_conversation

    è¯·æ±‚ä½“:
    {
      "user_id": str,
      "user_message": str,
      "training_plan_id": str (å¯é€‰),
      "diet_plan_id": str (å¯é€‰),
      "conversation_history": List[dict] (å¯é€‰)
    }

    å“åº”: Server-Sent Events
    data: {"type": "thinking", "content": "..."}
    data: {"type": "analysis", "content": "..."}
    data: {"type": "suggestion", "data": {...}}
    data: {"type": "complete"}
    """
    try:
        # è§£æè¯·æ±‚æ•°æ®
        data = req.get_json()
        user_id = data.get('user_id')
        user_message = data.get('user_message')
        training_plan_id = data.get('training_plan_id')
        diet_plan_id = data.get('diet_plan_id')
        conversation_history = data.get('conversation_history', [])

        if not user_id or not user_message:
            return Response(
                f'data: {json.dumps({"type": "error", "error": "ç¼ºå°‘å¿…éœ€å‚æ•°"})}\n\n',
                mimetype='text/event-stream'
            )

        logger.info(f'ğŸ’Š è¡¥å‰‚è®¡åˆ’å¯¹è¯ - User: {user_id}, Message: {user_message[:50]}...')

        # è·å–è®­ç»ƒè®¡åˆ’å’Œé¥®é£Ÿè®¡åˆ’
        training_plan = None
        diet_plan = None

        db = firestore.client()

        # è·å–è®­ç»ƒè®¡åˆ’ï¼ˆä½¿ç”¨ _get_planï¼‰
        if training_plan_id:
            try:
                plan_ref = db.collection('exercisePlans').document(training_plan_id)
                plan_doc = plan_ref.get()
                if plan_doc.exists:
                    training_plan = plan_doc.to_dict()
                    # éªŒè¯æƒé™
                    if training_plan.get('ownerId') != user_id:
                        logger.warning(f'âš ï¸ ç”¨æˆ· {user_id} æ— æƒè®¿é—®è®­ç»ƒè®¡åˆ’ {training_plan_id}')
                        training_plan = None
                    else:
                        logger.info(f'âœ… è·å–è®­ç»ƒè®¡åˆ’æˆåŠŸ: {training_plan.get("name")}')
            except Exception as e:
                logger.error(f'âŒ è·å–è®­ç»ƒè®¡åˆ’å¤±è´¥: {str(e)}')

        # è·å–é¥®é£Ÿè®¡åˆ’ï¼ˆä½¿ç”¨ _get_diet_planï¼‰
        if diet_plan_id:
            try:
                plan_ref = db.collection('dietPlans').document(diet_plan_id)
                plan_doc = plan_ref.get()
                if plan_doc.exists:
                    diet_plan = plan_doc.to_dict()
                    # éªŒè¯æƒé™
                    if diet_plan.get('ownerId') != user_id:
                        logger.warning(f'âš ï¸ ç”¨æˆ· {user_id} æ— æƒè®¿é—®é¥®é£Ÿè®¡åˆ’ {diet_plan_id}')
                        diet_plan = None
                    else:
                        logger.info(f'âœ… è·å–é¥®é£Ÿè®¡åˆ’æˆåŠŸ: {diet_plan.get("name")}')
            except Exception as e:
                logger.error(f'âŒ è·å–é¥®é£Ÿè®¡åˆ’å¤±è´¥: {str(e)}')

        # å¦‚æœæ²¡æœ‰æä¾›IDï¼Œå°è¯•è·å–æœ€æ–°çš„plansï¼ˆå¯é€‰ï¼‰
        if not training_plan:
            logger.info('ğŸ“‹ æœªæä¾›è®­ç»ƒè®¡åˆ’IDï¼Œå°è¯•è·å–æœ€æ–°è®­ç»ƒè®¡åˆ’')
            from plans.handlers import _get_coach_plans
            plans = _get_coach_plans(db, user_id, 'exercisePlans')
            if plans:
                training_plan = plans[0]
                logger.info(f'âœ… ä½¿ç”¨æœ€æ–°è®­ç»ƒè®¡åˆ’: {training_plan.get("name")}')

        if not diet_plan:
            logger.info('ğŸ½ï¸ æœªæä¾›é¥®é£Ÿè®¡åˆ’IDï¼Œå°è¯•è·å–æœ€æ–°é¥®é£Ÿè®¡åˆ’')
            from plans.handlers import _get_coach_plans
            plans = _get_coach_plans(db, user_id, 'dietPlans')
            if plans:
                diet_plan = plans[0]
                logger.info(f'âœ… ä½¿ç”¨æœ€æ–°é¥®é£Ÿè®¡åˆ’: {diet_plan.get("name")}')

        # è°ƒç”¨æµå¼ç”Ÿæˆ
        from .streaming import stream_generate_supplement_plan_conversation

        def generate():
            for event in stream_generate_supplement_plan_conversation(
                user_id=user_id,
                user_message=user_message,
                training_plan=training_plan,
                diet_plan=diet_plan,
                conversation_history=conversation_history
            ):
                yield f'data: {json.dumps(event, ensure_ascii=False)}\n\n'

        return Response(
            generate(),
            mimetype='text/event-stream',
            headers={
                'Cache-Control': 'no-cache',
                'X-Accel-Buffering': 'no'
            }
        )

    except Exception as e:
        logger.error(f'âŒ è¡¥å‰‚è®¡åˆ’å¯¹è¯å¤±è´¥: {str(e)}', exc_info=True)
        return Response(
            f'data: {json.dumps({"type": "error", "error": str(e)})}\n\n',
            mimetype='text/event-stream'
        )
```

---

#### 5. `functions/main.py` âœï¸ ä¿®æ”¹

**ä¿®æ”¹å†…å®¹**: å¯¼å‡ºæ–°å‡½æ•°

åœ¨ `__all__` åˆ—è¡¨ä¸­æ·»åŠ ï¼š

```python
from ai.handlers import (
    # ... ç°æœ‰å¯¼å‡º
    generate_supplement_plan_conversation,  # âœ¨ æ–°å¢
)

__all__ = [
    # ... ç°æœ‰å¯¼å‡º
    'generate_supplement_plan_conversation',  # âœ¨ æ–°å¢
]
```

---

### å‰ç«¯æ–°å¢/ä¿®æ”¹æ–‡ä»¶ï¼ˆ11ä¸ªï¼‰

#### 6. `lib/features/coach/plans/data/models/llm_chat_message.dart` âœï¸ ä¿®æ”¹

**ä¿®æ”¹å†…å®¹**: æ·»åŠ äº¤äº’å¼é€‰é¡¹æ”¯æŒ

```dart
// âœ¨ åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ  InteractiveOption ç±»
class InteractiveOption {
  final String id;           // plan_id
  final String label;        // "å¢è‚Œè®­ç»ƒè®¡åˆ’ A"
  final String? subtitle;    // "5å¤© Â· åˆ›å»ºäº2025-01-15"
  final String type;         // 'training_plan' | 'diet_plan'
  final Map<String, dynamic>? metadata;

  const InteractiveOption({
    required this.id,
    required this.label,
    this.subtitle,
    required this.type,
    this.metadata,
  });

  factory InteractiveOption.fromJson(Map<String, dynamic> json) {
    return InteractiveOption(
      id: json['id'] as String,
      label: json['label'] as String,
      subtitle: json['subtitle'] as String?,
      type: json['type'] as String,
      metadata: json['metadata'] as Map<String, dynamic>?,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'label': label,
      'subtitle': subtitle,
      'type': type,
      'metadata': metadata,
    };
  }
}

// âœ¨ ä¿®æ”¹ LLMChatMessage ç±»ï¼Œæ·»åŠ æ–°å­—æ®µ
class LLMChatMessage {
  final String role;
  final String content;
  final DateTime timestamp;
  final PlanEditSuggestion? suggestion;

  // âœ¨ æ–°å¢å­—æ®µ
  final List<InteractiveOption>? options;
  final String? interactionType;  // 'plan_selection' | null

  const LLMChatMessage({
    required this.role,
    required this.content,
    required this.timestamp,
    this.suggestion,
    this.options,          // âœ¨ æ–°å¢
    this.interactionType,  // âœ¨ æ–°å¢
  });

  // âœ¨ æ›´æ–° fromJson
  factory LLMChatMessage.fromJson(Map<String, dynamic> json) {
    final optionsJson = json['options'] as List<dynamic>?;
    final options = optionsJson?.map((o) =>
      InteractiveOption.fromJson(o as Map<String, dynamic>)
    ).toList();

    return LLMChatMessage(
      role: json['role'] as String,
      content: json['content'] as String,
      timestamp: DateTime.parse(json['timestamp'] as String),
      suggestion: json['suggestion'] != null
          ? PlanEditSuggestion.fromJson(json['suggestion'] as Map<String, dynamic>)
          : null,
      options: options,
      interactionType: json['interactionType'] as String?,
    );
  }

  // âœ¨ æ›´æ–° toJson
  Map<String, dynamic> toJson() {
    return {
      'role': role,
      'content': content,
      'timestamp': timestamp.toIso8601String(),
      'suggestion': suggestion?.toJson(),
      'options': options?.map((o) => o.toJson()).toList(),
      'interactionType': interactionType,
    };
  }

  // âœ¨ æ›´æ–° copyWith
  LLMChatMessage copyWith({
    String? role,
    String? content,
    DateTime? timestamp,
    PlanEditSuggestion? suggestion,
    List<InteractiveOption>? options,
    String? interactionType,
  }) {
    return LLMChatMessage(
      role: role ?? this.role,
      content: content ?? this.content,
      timestamp: timestamp ?? this.timestamp,
      suggestion: suggestion ?? this.suggestion,
      options: options ?? this.options,
      interactionType: interactionType ?? this.interactionType,
    );
  }
}
```

---

#### 7. `lib/features/coach/plans/data/models/supplement_stream_event.dart` âœ¨ æ–°å»ºæ–‡ä»¶

```dart
/// è¡¥å‰‚è®¡åˆ’æµå¼ç”Ÿæˆäº‹ä»¶
class SupplementStreamEvent {
  final String type;  // 'thinking' | 'analysis' | 'suggestion' | 'complete' | 'error'
  final String? content;
  final Map<String, dynamic>? data;
  final String? error;

  const SupplementStreamEvent({
    required this.type,
    this.content,
    this.data,
    this.error,
  });

  factory SupplementStreamEvent.fromJson(Map<String, dynamic> json) {
    return SupplementStreamEvent(
      type: json['type'] as String,
      content: json['content'] as String?,
      data: json['data'] as Map<String, dynamic>?,
      error: json['error'] as String?,
    );
  }

  bool get isThinking => type == 'thinking';
  bool get isAnalysis => type == 'analysis';
  bool get isSuggestion => type == 'suggestion';
  bool get isComplete => type == 'complete';
  bool get isError => type == 'error';

  @override
  String toString() {
    return 'SupplementStreamEvent(type: $type, hasContent: ${content != null}, hasData: ${data != null})';
  }
}
```

---

#### 8. `lib/features/coach/plans/data/models/supplement_creation_state.dart` âœ¨ æ–°å»ºæ–‡ä»¶

```dart
import 'package:coach_x/features/coach/plans/data/models/llm_chat_message.dart';
import 'package:coach_x/features/coach/plans/data/models/supplement_day.dart';

/// è¡¥å‰‚è®¡åˆ’åˆ›å»ºçŠ¶æ€
class SupplementCreationState {
  final List<LLMChatMessage> messages;
  final bool isAIResponding;
  final SupplementDay? pendingSuggestion;
  final String? errorMessage;
  final bool canSendMessage;

  // å¤šæ­¥é€‰æ‹©çŠ¶æ€
  final SelectionStep? currentSelectionStep;
  final String? selectedTrainingPlanId;
  final String? selectedDietPlanId;
  final String? selectedTrainingPlanName;
  final String? selectedDietPlanName;

  const SupplementCreationState({
    this.messages = const [],
    this.isAIResponding = false,
    this.pendingSuggestion,
    this.errorMessage,
    this.canSendMessage = true,
    this.currentSelectionStep,
    this.selectedTrainingPlanId,
    this.selectedDietPlanId,
    this.selectedTrainingPlanName,
    this.selectedDietPlanName,
  });

  SupplementCreationState copyWith({
    List<LLMChatMessage>? messages,
    bool? isAIResponding,
    SupplementDay? pendingSuggestion,
    String? errorMessage,
    bool? canSendMessage,
    SelectionStep? currentSelectionStep,
    String? selectedTrainingPlanId,
    String? selectedDietPlanId,
    String? selectedTrainingPlanName,
    String? selectedDietPlanName,
  }) {
    return SupplementCreationState(
      messages: messages ?? this.messages,
      isAIResponding: isAIResponding ?? this.isAIResponding,
      pendingSuggestion: pendingSuggestion ?? this.pendingSuggestion,
      errorMessage: errorMessage ?? this.errorMessage,
      canSendMessage: canSendMessage ?? this.canSendMessage,
      currentSelectionStep: currentSelectionStep ?? this.currentSelectionStep,
      selectedTrainingPlanId: selectedTrainingPlanId ?? this.selectedTrainingPlanId,
      selectedDietPlanId: selectedDietPlanId ?? this.selectedDietPlanId,
      selectedTrainingPlanName: selectedTrainingPlanName ?? this.selectedTrainingPlanName,
      selectedDietPlanName: selectedDietPlanName ?? this.selectedDietPlanName,
    );
  }
}

/// é€‰æ‹©æ­¥éª¤æšä¸¾
enum SelectionStep {
  training,  // æ­£åœ¨é€‰æ‹©è®­ç»ƒè®¡åˆ’
  diet,      // æ­£åœ¨é€‰æ‹©é¥®é£Ÿè®¡åˆ’
}
```

---

## ğŸ“Š å®æ–½æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1ï¼šåç«¯åŸºç¡€è®¾æ–½ âœ… 5/5 - å·²å®Œæˆ

- [x] 1. åœ¨`functions/ai/tools.py`ä¸­æ·»åŠ `get_supplement_day_tool()`
- [x] 2. åˆ›å»º`functions/ai/supplement_plan/prompts.py`
- [x] 3. åœ¨`functions/ai/streaming.py`ä¸­æ·»åŠ `stream_generate_supplement_plan_conversation()`
- [x] 4. åœ¨`functions/ai/handlers.py`ä¸­æ·»åŠ `generate_supplement_plan_conversation`
- [x] 5. åœ¨`functions/main.py`ä¸­å¯¼å‡ºæ–°å‡½æ•°

### é˜¶æ®µ2ï¼šå‰ç«¯æ•°æ®å±‚ âœ… 5/5 - å·²å®Œæˆ

- [x] 6. æ‰©å±•`lib/features/coach/plans/data/models/llm_chat_message.dart`
- [x] 7. åˆ›å»º`lib/features/coach/plans/data/models/supplement_stream_event.dart`
- [x] 8. åˆ›å»º`lib/features/coach/plans/data/models/supplement_creation_state.dart`
- [x] 9. åœ¨`lib/core/services/ai_service.dart`ä¸­æ·»åŠ `generateSupplementPlanConversation()`
- [x] 10. åœ¨`create_supplement_plan_notifier.dart`ä¸­æ·»åŠ `applyAIGeneratedDay()`

### é˜¶æ®µ3ï¼šå‰ç«¯çŠ¶æ€ç®¡ç† âœ… 2/2 - å·²å®Œæˆ

- [x] 11. åˆ›å»º`supplement_conversation_notifier.dart`
- [x] 12. åˆ›å»º`supplement_conversation_providers.dart`

### é˜¶æ®µ4ï¼šå‰ç«¯UIç»„ä»¶ â³ 0/4 - å¾…å®Œæˆ

- [ ] 13. ä¿®æ”¹`chat_message_bubble.dart`ï¼ˆæ·»åŠ äº¤äº’å¼é€‰é¡¹æ”¯æŒï¼‰
- [ ] 14. åˆ›å»º`ai_supplement_creation_panel.dart`
- [ ] 15. åˆ›å»º`supplement_suggestion_card.dart`
- [ ] 16. ä¿®æ”¹`create_supplement_plan_page.dart`ï¼ˆæ·»åŠ SparkleæŒ‰é’®ï¼‰

### é˜¶æ®µ5ï¼šé›†æˆæµ‹è¯• â³ 0/2 - å¾…å®Œæˆ

- [ ] 17. æœ¬åœ°æµ‹è¯•ï¼šFirebase emulator
- [ ] 18. ç«¯åˆ°ç«¯æµ‹è¯•ï¼šå®Œæ•´æµç¨‹

---

**å½“å‰è¿›åº¦**: 17/21 ä»»åŠ¡å®Œæˆ (81%)

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### å‰©ä½™ä»»åŠ¡ï¼ˆåœ¨æ–°conversationå®Œæˆï¼‰

**é˜¶æ®µ4ï¼šå‰ç«¯UIç»„ä»¶** (é¢„è®¡2-3å°æ—¶)
1. ä¿®æ”¹ `chat_message_bubble.dart` - æ·»åŠ InteractiveOptionæ¸²æŸ“é€»è¾‘
2. åˆ›å»º `ai_supplement_creation_panel.dart` - å®ç°70% modal sheet
3. åˆ›å»º `supplement_suggestion_card.dart` - å®ç°è¡¥å‰‚å»ºè®®å¡ç‰‡
4. ä¿®æ”¹ `create_supplement_plan_page.dart` - æ·»åŠ SparkleæŒ‰é’®

**é˜¶æ®µ5ï¼šé›†æˆæµ‹è¯•** (é¢„è®¡1-2å°æ—¶)
1. å¯åŠ¨ Firebase Emulator è¿›è¡Œæœ¬åœ°æµ‹è¯•
2. å®Œæ•´æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯•
3. Bugä¿®å¤å’Œä¼˜åŒ–

### éƒ¨ç½²æ¸…å•

```bash
# 1. éƒ¨ç½²åç«¯
cd functions
firebase deploy --only functions

# 2. Flutterä»£ç ç”Ÿæˆï¼ˆå¦‚éœ€è¦ï¼‰
flutter pub run build_runner build --delete-conflicting-outputs

# 3. è¿è¡Œåº”ç”¨æµ‹è¯•
flutter run

# 4. ä»£ç åˆ†æ
flutter analyze
```

---

**æœ€åæ›´æ–°**: 2025-01-02
**æ–‡æ¡£ç‰ˆæœ¬**: 1.1
**æ‰§è¡Œè¿›åº¦**: 81% (17/21ä»»åŠ¡)
